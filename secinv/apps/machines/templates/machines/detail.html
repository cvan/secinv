{% extends "machines/base.html" %}
{% load i18n %}
{% load machine_extras %}

{% block head_title %}{{ machine.hostname }} | {{ block.super }}{% endblock %}

{% block content %}
      <h2><em>{{ machine.sys_ip }}</em> {{ machine.hostname }}</h2>

      <table>
        <caption>{{ _('Machine details') }}</caption>
        <tbody>
          <tr>
            <th>{{ _('IP address') }}</th>
            <td>
              {{ machine.sys_ip }}
            </td>
          </tr>
          <tr>
            <th>{{ _('Hostname') }}</th>
            <td>{{ machine.hostname }}</td>
          </tr>
          <tr>
            <th>{{ _('External IP address') }}</th>
            <td>
              {{ machine.ext_ip }}
            </td>
          </tr>
{# TODO: uniform date format #}
          <tr>
            <th>{{ _('Added') }}</th>
            <td>
              {% if machine.date_added %}
              <time datetime="{{ machine.date_added|date:'c' }}">
                {{ machine.date_added }}
              </time>
              {% endif %}
            </td>
          </tr>
          <tr>
            <th>{{ _('Modified') }}</th>
            <td>
            {% if machine.date_modified %}
              <time datetime="{{ machine.date_modified|date:'c'|default:'0000-00-00T00:00:00.000000' }}">
                {{ machine.date_modified }}
              </time>
            {% endif %}
            </td>
          </tr>
          <tr>
            <th>{{ _('Scanned') }}</th>
            <td>
              {% if machine.date_scanned %}
              <time datetime="{{ machine.date_scanned|date:'c' }}">
                {{ machine.date_scanned }}
              </time>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>

      <h3>{{ _('System') }}</h3>
      <table>
        <caption>{{ _('Latest') }}</caption>
        <tbody>
          <tr>
            <th>{{ _('Kernel release') }}</th>
            {# TODO: dict differences #}
            {# ins, mark #}
            <td>
              {% spaceless %}
              {% if 'kernel_rel' in system.differences %}
                {% with system.differences.kernel_rel as system_dict %}
                  {% if system_dict.new and not system_dict.old %}
                      <ins>{{ system.kernel_rel }}</ins>
                  {% else %}
                    {% if system_dict.new and system_dict.old %}
                      <mark>{{ system.kernel_rel }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ system.kernel_rel }}
              {% endif %}
              {% endspaceless %}
            </td>
          </tr>
          <tr>
            <th>{{ _('RedHat release') }}</th>
            <td>
              {% spaceless %}
              {% if 'rh_rel' in system.differences %}
                {% with system.differences.rh_rel as system_dict %}
                  {% if system_dict.new and not system_dict.old %}
                      <ins>{{ system.rh_rel }}</ins>
                  {% else %}
                    {% if system_dict.new and system_dict.old %}
                      <mark>{{ system.rh_rel }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ system.rh_rel }}
              {% endif %}
              {% endspaceless %}
            </td>
          </tr>
          <tr>
            <th>{{ _('NFS mounted?') }}</th>
            <td>
              {% spaceless %}
              {% if 'nfs' in system.differences %}
                {% with system.differences.nfs as system_dict %}
                  {% if system_dict.new and not system_dict.old %}
                      <ins>{{ system.nfs_mounted }}</ins>
                  {% else %}
                    {% if system_dict.old %}
                      <mark>{{ system.nfs_mounted }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ system.nfs_mounted }}
              {% endif %}
              {% endspaceless %}
            </td>
          </tr>
          <tr>
            <th>{{ _('Modified') }}</th>
            <td>
              {% if system.date_added %}
              <time datetime="{{ system.date_added|date:'c' }}">
                {{ system.date_added }}
              </time>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>

      <table>
        <caption>{{ _('Change history') }}</caption>
        <thead>
          <tr>
            <th>{{ _('Kernel release') }}</th>
            <th>{{ _('RedHat release') }}</th>
            <th>{{ _('NFS') }}</th>
            <th>{{ _('Date modified') }}</th>
          </tr>
        </thead>
        <tbody>
{% for system_h in system_history %}
          <tr>
            <td>
              {% spaceless %}
              {% if 'kernel_rel' in system_h.differences %}
                {% with system_h.differences.kernel_rel as system_dict %}
                  {% if system_dict.new and not system_dict.old %}
                      <ins>{{ system_h.kernel_rel }}</ins>
                  {% else %}
                    {% if system_dict.new and system_dict.old %}
                      <mark>{{ system_h.kernel_rel }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ system_h.kernel_rel }}
              {% endif %}
              {% endspaceless %}
            </td>
            <td>
              {% spaceless %}
              {% if 'rh_rel' in system_h.differences %}
                {% with system_h.differences.rh_rel as system_dict %}
                  {% if system_dict.new and not system_dict.old %}
                      <ins>{{ system_h.rh_rel }}</ins>
                  {% else %}
                    {% if system_dict.new and system_dict.old %}
                      <mark>{{ system_h.rh_rel }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ system_h.rh_rel }}
              {% endif %}
              {% endspaceless %}
            </td>
            <td>
              {% spaceless %}
              {% if 'nfs' in system_h.differences %}
                {% with system_h.differences.nfs as system_dict %}
                  {% if system_dict.new and not system_dict.old %}
                      <ins>{{ system_h.nfs_mounted }}</ins>
                  {% else %}
                    {% if system_dict.old %}
                      <mark>{{ system_h.nfs_mounted }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ system_h.nfs_mounted }}
              {% endif %}
              {% endspaceless %}
            </td>
            <td>
              <time datetime="{{ system_h.date_added|date:'c' }}">
                {{ system_h.date_added }}
              </time>
            </td>
          </tr>
{% empty %}
          <tr>
            <td></td>
          </tr>
{% endfor %}
        </tbody>
      </table>


      <h3>{{ _('Services listening') }}</h3>
      <table>
        <caption>{{ _('Latest') }}</caption>
        <thead>
          <tr>
            <th>{{ _('Process') }}</th>
            <th>{{ _('Port') }}</th>
            <th>{{ _('Date modified') }}</th>
          </tr>
        </thead>
        <tbody>

          <tr>
            <td>
              {% if services.processes_split %}
              <ul>
                {% for process, port in services.processes_dict.items %}
                {% spaceless %}
                <li>
                {# Check if key has been changed. #}
                {% if process in services.differences %}

                  {% with services.differences|dict_get:process as process_dict %}
                    {% if process_dict.new and not process_dict.old %}
                        <ins>{{ process }}</ins>
                    {% else %}
                      {% if process_dict.new and process_dict.old %}
                        <mark>{{ process }}</mark>
                      {% endif %}

                      {% if process_dict.deleted %}
                        <del>{{ process }}</del>
                      {% endif %}
                    {% endif %}
                  {% endwith %}

                {% else %}
                        {{ process }}
                {% endif %}
                </li>
                {% endspaceless %}
                {% endfor %}
              </ul>
              {% endif %}
            </td>
            <td>
              {% if services.ports_split %}
              <ul>
                {% for process, port in services.processes_dict.items %}
                {% spaceless %}
                <li>
                  {# Check if key has been changed. #}
                  {% if process in services.differences %}

                    {% with services.differences|dict_get:process as process_dict %}
                      {% if process_dict.new and not process_dict.old %}
                          <ins>{{ port }}</ins>
                      {% else %}
                        {% if process_dict.new and process_dict.old %}
                          <mark>{{ process_dict.new }}</mark>
                        {% endif %}

                        {% if process_dict.deleted %}
                          <del>{{ port }}</del>
                        {% endif %}
                      {% endif %}
                    {% endwith %}

                  {% else %}
                          {{ port }}
                  {% endif %}
                </li>
                {% endspaceless %}
                {% endfor %}
              </ul>
              {% endif %}
            </td>
            <td>
              <time datetime="{{ services.date_added|date:'c' }}">
                {{ services.date_added }}
              </time>
            </td>
          </tr>

        </tbody>
      </table>

      <table>
        <caption>{{ _('Change history') }}</caption>
        <thead>
          <tr>
            <th>{{ _('Process') }}</th>
            <th>{{ _('Port') }}</th>
            <th>{{ _('Date modified') }}</th>
          </tr>
        </thead>
        <tbody>
{% for services_h in services_history %}
          <tr>
            <td>
              {% if services_h.processes_split %}
              <ul>
                {% for process, port in services_h.processes_dict.items %}
                {% spaceless %}
                <li>
                {# Check if key has been changed. #}
                {% if process in services_h.differences %}

                  {% with services_h.differences|dict_get:process as process_dict %}
                    {% if process_dict.new and not process_dict.old %}
                        <ins>{{ process }}</ins>
                    {% else %}
                      {% if process_dict.new and process_dict.old %}
                        <mark>{{ process }}</mark> <!-- {{ process_dict.new }} -->
                      {% endif %}

                      {% if process_dict.deleted %}
                        <del>{{ process }}</del> <!--{{ process_dict.deleted }} -->
                      {% endif %}
                    {% endif %}
                  {% endwith %}

                {% else %}
                        {{ process }}
                {% endif %}

                </li>
                {% endspaceless %}
                {% endfor %}
              </ul>
              {% endif %}
            </td>
            <td>
              {% if services_h.ports_split %}
              <ul>
                {% for process, port in services_h.processes_dict.items %}
                {% spaceless %}
                <li>
                  {# Check if key has been changed. #}
                  {% if process in services_h.differences %}

                    {% with services_h.differences|dict_get:process as process_dict %}
                      {% if process_dict.new and not process_dict.old %}
                          <ins>{{ port }}</ins>
                      {% else %}
                        {% if process_dict.new and process_dict.old %}
                          <mark>{{ process_dict.new }}</mark>
                        {% endif %}

                        {% if process_dict.deleted %}
                          <del>{{ port }}</del> <!--{{ process_dict.deleted }} -->
                        {% endif %}
                      {% endif %}
                    {% endwith %}

                  {% else %}
                          {{ port }}
                  {% endif %}
                </li>
                {% endspaceless %}
                {% endfor %}
              </ul>
              {% endif %}
            </td>
            <td>
              <time datetime="{{ services_h.date_added|date:'c' }}">
                {{ services_h.date_added }}
              </time>
            </td>
          </tr>
{% empty %}
          <tr>
            <td></td>
          </tr>
{% endfor %}
        </tbody>
      </table>


      <h3>{{ _('RPMs') }}</h3>
      <h4>{{ _('Installed RPMs') }}</h4>
      {% if rpms %}
      <p>
        <strong>{{ _('Last Modified') }}</strong>
        <time datetime="{{ rpms.date_added|date:'c' }}">
          {{ rpms.date_added }}
        </time>
      </p>
      <ul>
        {% for rpm in rpms.installed %}
        <li>{{ rpm }}</li>
        {% endfor %}
      </ul>
      {% endif %}

      <table>
        <caption>{{ _('Change history') }}</caption>
        <thead>
          <tr>
            <th>{{ _('Installed') }}</th>
            <th>{{ _('Removed') }}</th>
            <th>{{ _('Date modified') }}</th>
          </tr>
        </thead>
        <tbody>
{% for rpms_h in rpms_history %}
          <tr>
            <td>
              {% if rpms_h.differences.added %}
              <ul>
                {% for rpm in rpms_h.differences.added %}
                <li><ins>{{ rpm }}</ins></li>
                {% endfor %}
              </ul>
              {% endif %}
            </td>
            <td>
              {% if rpms_h.differences.deleted %}
              <ul>
                {% for rpm in rpms_h.differences.deleted %}
                <li><del class="visible">{{ rpm }}</del></li>
                {% endfor %}
              </ul>
              {% endif %}
            </td>
            <td>
              <time datetime="{{ rpms_h.date_added|date:'c' }}">
                {{ rpms_h.date_added }}
              </time>
          </tr>
{% empty %}
          <tr>
            <td></td>
          </tr>
{% endfor %}
        </tbody>
      </table>


{% if interfaces %}
      <table>
        <caption>{{ _('Interfaces') }}</caption>
        <thead>
          <tr>
            <th>{{ _('Interface name') }}</th>
            <th>{{ _('IP address') }}</th>
            <th>{{ _('MAC address') }}</th>
            <th>{{ _('Netmask') }}</th>
            <th>{{ _('Modified') }}</th>
          </tr>
        </thead>
        <tbody>
      {% for interface in interfaces %}
          <tr>
            <td>
              {% if interface.id in interfaces_oldest %}<ins>{% endif %}
              {% if not interface.active %}<del>{% endif %}
              {{ interface.i_name }}
              {% if not interface.active %}</del>{% endif %}
              {% if interface.id in interfaces_oldest %}</ins>{% endif %}
            </td>
            <td>
              {% if not interface.active %}<del>{% endif %}

              {% spaceless %}
              {% if 'i_ip' in interface.differences %}
                {% with interface.differences.i_ip as interface_dict %}
                  {% if interface_dict.new and not interface_dict.old %}
                      <ins>{{ interface.i_ip }}</ins>
                  {% else %}
                    {% if interface_dict.new and interface_dict.old %}
                      <mark>{{ interface.i_ip }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ interface.i_ip }}
              {% endif %}
              {% endspaceless %}

              {% if not interface.active %}</del>{% endif %}
            </td>
            <td>
              {% if not interface.active %}<del>{% endif %}

              {% spaceless %}
              {% if 'i_mac' in interface.differences %}
                {% with interface.differences.i_mac as interface_dict %}
                  {% if interface_dict.new and not interface_dict.old %}
                      <ins>{{ interface.i_mac }}</ins>
                  {% else %}
                    {% if interface_dict.new and interface_dict.old %}
                      <mark>{{ interface.i_mac }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ interface.i_mac }}
              {% endif %}
              {% endspaceless %}

              {% if not interface.active %}</del>{% endif %}
            </td>
            <td>
              {% if not interface.active %}<del>{% endif %}

              {% spaceless %}
              {% if 'i_mask' in interface.differences %}
                {% with interface.differences.i_mask as interface_dict %}
                  {% if interface_dict.new and not interface_dict.old %}
                      <ins>{{ interface.i_mask }}</ins>
                  {% else %}
                    {% if interface_dict.new and interface_dict.old %}
                      <mark>{{ interface.i_mask }}</mark>
                    {% endif %}
                  {% endif %}
                {% endwith %}
              {% else %}
                      {{ interface.i_mask }}
              {% endif %}
              {% endspaceless %}

              {% if not interface.active %}</del>{% endif %}
            </td>
            <td>
              {% if interface.date_added %}
              <time datetime="{{ interface.date_added|date:'c' }}">
                {{ interface.date_added }}
              </time>
              {% endif %}
            </td>
          </tr>
      {% endfor %}
        </tbody>
      </table>
{% endif %}

<table>
  <caption>{{ _('Change history') }}</caption>
  <thead>
    <tr>
      <th>{{ _('Interface name') }}</th>
      <th>{{ _('IP address') }}</th>
      <th>{{ _('MAC address') }}</th>
      <th>{{ _('Netmask') }}</th>
      <th>{{ _('Modified') }}</th>
    </tr>
  </thead>
  <tbody>
    {% for interface_h in interfaces_history %}
    <tr>
      <td>
        {% if interface_h.id in interfaces_oldest %}<ins>{% endif %}
        {% if not interface_h.active %}<del>{% endif %}
        {{ interface_h.i_name }}
        {% if not interface_h.active %}</del>{% endif %}
        {% if interface_h.id in interfaces_oldest %}</ins>{% endif %}
      </td>
      <td>
        {% if not interface_h.active %}<del>{% endif %}

        {% spaceless %}
        {% if 'i_ip' in interface_h.differences %}
          {% with interface_h.differences.i_ip as interface_dict %}
            {% if interface_dict.new and not interface_dict.old %}
                <ins>{{ interface_h.i_ip }}</ins>
            {% else %}
              {% if interface_dict.new and interface_dict.old %}
                <mark>{{ interface_h.i_ip }}</mark>
              {% endif %}
            {% endif %}
          {% endwith %}
        {% else %}
                {{ interface_h.i_ip }}
        {% endif %}
        {% endspaceless %}

        {% if not interface_h.active %}</del>{% endif %}
      </td>
      <td>
        {% if not interface_h.active %}<del>{% endif %}

        {% spaceless %}
        {% if 'i_mac' in interface_h.differences %}
          {% with interface_h.differences.i_mac as interface_dict %}
            {% if interface_dict.new and not interface_dict.old %}
                <ins>{{ interface_h.i_mac }}</ins>
            {% else %}
              {% if interface_dict.new and interface_dict.old %}
                <mark>{{ interface_h.i_mac }}</mark>
              {% endif %}
            {% endif %}
          {% endwith %}
        {% else %}
                {{ interface_h.i_mac }}
        {% endif %}
        {% endspaceless %}

        {% if not interface_h.active %}</del>{% endif %}
      </td>
      <td>
        {% if not interface_h.active %}<del>{% endif %}

        {% spaceless %}
        {% if 'i_mask' in interface_h.differences %}
          {% with interface_h.differences.i_mask as interface_dict %}
            {% if interface_dict.new and not interface_dict.old %}
                <ins>{{ interface_h.i_mask }}</ins>
            {% else %}
              {% if interface_dict.new and interface_dict.old %}
                <mark>{{ interface_h.i_mask }}</mark>
              {% endif %}
            {% endif %}
          {% endwith %}
        {% else %}
                {{ interface_h.i_mask }}
        {% endif %}
        {% endspaceless %}

        {% if not interface_h.active %}</del>{% endif %}
      </td>
      <td>
        <time datetime="{{ interface_h.date_added|date:'c' }}">
          {{ interface_h.date_added }}
        </time>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>


{% endblock %}
